<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book Appointment — South Fade</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,Arial,sans-serif;background:#000;color:#fff;padding:20px;min-height:100vh}
    .container{max-width:900px;margin:0 auto;background:#111;border:1px solid #333;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.6)}
    .header{background:#000;color:#ffd700;padding:28px;text-align:center;border-bottom:2px solid #ffd700}
    .header h1{margin-bottom:6px;font-size:1.8rem}
    .content{padding:28px}
    label{display:block;margin-bottom:6px;color:#ffd700;font-weight:600}
    input,select,textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #333;background:#1a1a1a;color:#fff;font-size:1rem;margin-bottom:14px}
    .flex{display:flex;gap:12px}
    .col{flex:1}
    .time-slots{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:8px}
    .slot{padding:10px;border-radius:8px;background:#222;border:1px solid #444;text-align:center;cursor:pointer;user-select:none}
    .slot:hover:not(.disabled){background:#2a2a2a;border-color:#ffd700;transform:translateY(-2px)}
    .slot.selected{background:#ffd700;color:#000;border-color:#ffd700;font-weight:700}
    .slot.disabled{background:#1a1a1a;color:#666;opacity:.6;cursor:not-allowed;text-decoration:line-through}
    .btn{width:100%;padding:14px;border-radius:8px;border:none;background:linear-gradient(135deg,#ffd700,#d4af37);color:#000;font-weight:800;cursor:pointer}
    .btn:disabled{background:#444;color:#777;cursor:not-allowed}
    .message{margin:16px 0;padding:12px;border-radius:8px;display:none}
    .message.active{display:block}
    .message.success{background:rgba(40,167,69,.08);color:#8fe08f;border:1px solid #2b7a44}
    .message.error{background:rgba(220,53,69,.06);color:#ff9aa8;border:1px solid #8a2a33}
    .loading{display:none;text-align:center;color:#ffd700;margin-top:10px}
    .loading.active{display:block}
    .muted{color:#999;font-size:.9rem}
    .gold-note{color:#FFD700;font-size:0.9rem;margin-top:10px;text-align:center}
    @media(max-width:640px){.flex{flex-direction:column}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-cut"></i> South Fade Barbershop</h1>
      <div class="muted">Book your appointment — fast & simple</div>
    </div>

    <div class="content">
      <div id="msg" class="message"></div>

      <form id="bookingForm" autocomplete="off">
        <label for="name">Full name *</label>
        <input id="name" name="name" type="text" required placeholder="Alex Johnson">

        <div class="flex">
          <div class="col">
            <label for="email">Email *</label>
            <input id="email" name="email" type="email" required placeholder="you@example.com">
          </div>
          <div class="col">
            <label for="phone">Phone *</label>
            <input id="phone" name="phone" type="tel" required placeholder="+44 7...">
          </div>
        </div>

        <label for="service">Service *</label>
        <select id="service" required>
          <option value="">-- choose a service --</option>
        </select>

        <div class="flex">
          <div class="col">
            <label for="date">Preferred date *</label>
            <input id="date" type="date" required>
          </div>
          <div class="col">
            <label for="barber">Choose Master Barber *</label>
            <select id="barber" required>
              <option value="">-- choose master barber --</option>
              <option value="Moh">Moh</option>
              <option value="Alex">Alex</option>
              <option value="Yass">Yass</option>
              <option value="Ali">Ali</option>
            </select>
          </div>
        </div>

        <label>Available time slots *</label>
        <div id="slots" class="time-slots" aria-live="polite"></div>
        <input id="time" name="time" type="hidden" required>

        <label for="notes">Notes (optional)</label>
        <textarea id="notes" rows="3" placeholder="Anything we should know?"></textarea>

        <p class="gold-note">At South Fade we kindly ask you to cancel your booking before rescheduling.</p>

        <div style="margin-top:14px"><button id="submitBtn" class="btn" type="submit">Book appointment</button></div>
        <div id="loading" class="loading">Processing…</div>
      </form>

      <p class="muted" style="margin-top:18px">If you see a server error, open browser DevTools (Console) and paste the response here for help.</p>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://ufcfbggsjemgzcmdhpts.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmY2ZiZ2dzamVnZnpjYm1kcHB0cyIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNzYwMzYzMzY2LCJleHAiOjIwNzU5MzkzNjZ9.IWB96tPDcVcCp36azPNLewik41xL3FrDjLLtIMqwT-4';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const services = [
  { cat: 'Classic/Fade', items: [ { name:'Buzz cut Fade', price:24, dur:40 }, { name:'Wash & cut', price:25, dur:40 }, { name:'Skin Fade', price:27, dur:40 } ] },
  { cat: 'Scissor Cut', items: [ { name:'Scissor Cut', price:27, dur:40 }, { name:'Restyle Cut', price:30, dur:40 } ] },
  { cat: 'Beard Trim', items: [ { name:'Beard Trim Clipper', price:17, dur:30 }, { name:'Beard Trim + Hot Towel', price:20, dur:30 } ] },
  { cat: 'Special Treatment', items: [ { name:'Facial', price:20, dur:30 }, { name:'Face Mask', price:10, dur:30 } ] }
];

const barberSchedule = {
  Moh:[1,2,3],
  Alex:[1,2,3,4,5],
  Yass:[4,5,6],
  Ali:[5,6,0]
};

const form = document.getElementById('bookingForm');
const serviceSel = document.getElementById('service');
const dateInp = document.getElementById('date');
const barberSel = document.getElementById('barber');
const slotsDiv = document.getElementById('slots');
const timeInp = document.getElementById('time');
const notesInp = document.getElementById('notes');
const msgDiv = document.getElementById('msg');
const submitBtn = document.getElementById('submitBtn');

function showMessage(text, type='error', duration=5000) {
  msgDiv.textContent = text;
  msgDiv.className = `message ${type} active`;
  setTimeout(()=> msgDiv.classList.remove('active'), duration);
}

function populateServices() {
  services.forEach(group => {
    const og = document.createElement('optgroup');
    og.label = group.cat;
    group.items.forEach(item => {
      const opt = document.createElement('option');
      opt.value = JSON.stringify(item);
      opt.textContent = `${item.name} — £${item.price}`;
      og.appendChild(opt);
    });
    serviceSel.appendChild(og);
  });
}

function updateBarbersForDate(dateStr) {
  if (!dateStr) return;
  const day = new Date(dateStr).getDay();
  Array.from(barberSel.options).forEach(opt => {
    if (!opt.value) return;
    const sched = barberSchedule[opt.value];
    if (!sched.includes(day)) {
      opt.disabled = true;
    } else {
      opt.disabled = false;
    }
  });
}

function genSlots(open, close, dur) {
  const arr = [];
  for (let h = open; h < close; h++) {
    for (let m = 0; m < 60; m += dur) {
      arr.push(`${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`);
    }
  }
  return arr;
}

async function getBookedSlots(date, barber) {
  const { data, error } = await supabase
    .from('bookings')
    .select('booking_time')
    .eq('barber', barber)
    .eq('booking_date', date)
    .eq('status', 'confirmed');
  if (error) {
    console.error('getBookedSlots error', error);
    return [];
  }
  return (data || []).map(r => r.booking_time);
}

async function renderSlots() {
  timeInp.value = '';
  slotsDiv.innerHTML = '';
  const svcVal = serviceSel.value;
  const dateVal = dateInp.value;
  const barberVal = barberSel.value;
  if (!svcVal || !dateVal || !barberVal) {
    slotsDiv.innerHTML = `<div class="muted">Select service, date and master barber</div>`;
    return;
  }
  const svc = JSON.parse(svcVal);
  const day = new Date(dateVal).getDay();
  const [open, close] = (day === 0) ? [9,18] : (day === 6) ? [9,19] : [9,20];
  const all = genSlots(open, close, svc.dur);
  const booked = await getBookedSlots(dateVal, barberVal);

  all.forEach(t => {
    const el = document.createElement('div');
    el.className = 'slot';
    el.textContent = t;
    if (booked.includes(t)) {
      el.classList.add('disabled');
    } else {
      el.addEventListener('click', () => {
        document.querySelectorAll('.slot.selected').forEach(s => s.classList.remove('selected'));
        el.classList.add('selected');
        timeInp.value = t;
      });
    }
    slotsDiv.appendChild(el);
  });
}

async function createBooking(payload) {
  const { data, error } = await supabase
    .from('bookings')
    .insert([{ ...payload, status: 'confirmed' }]);
  if (error) {
    console.error('createBooking error', error);
    return { success: false, error: error.message || 'Booking failed' };
  }
  return { success: true, data };
}

form.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const name = form.name.value.trim();
  const email = form.email.value.trim();
  const phone = form.phone.value.trim();
  const svc = serviceSel.value ? JSON.parse(serviceSel.value) : null;
  const date = dateInp.value;
  const barber = barberSel.value;
  const time = timeInp.value;
  const notes = notesInp.value.trim();
  if (!name || !email || !phone || !svc || !date || !barber || !time) {
    showMessage('Please fill all required fields and pick a time slot', 'error');
    return;
  }

  // Optional: check again before sending
  const ok = await isSlotAvailable(barber, date, time);
  if (!ok) {
    showMessage('This time slot has just been booked. Please pick another.', 'error');
    return;
  }

  submitBtn.disabled = true;
  const payload = { customer_name: name, customer_email: email, customer_phone: phone, barber, service: svc.name, booking_date: date, booking_time: time, notes };
  const result = await createBooking(payload);
  if (result.success) {
    showMessage('Booking confirmed! Check your email.', 'success', 7000);
    form.reset();
    slotsDiv.innerHTML = '';
  } else {
    showMessage(result.error || 'Booking failed.', 'error', 8000);
  }
  submitBtn.disabled = false;
});

dateInp.addEventListener('change', () => { updateBarbersForDate(dateInp.value); renderSlots(); });
barberSel.addEventListener('change', renderSlots);
serviceSel.addEventListener('change', renderSlots);

document.addEventListener('DOMContentLoaded', () => {
  populateServices();
  dateInp.min = new Date().toISOString().split('T')[0];
});
</script>
</body>
</html>
