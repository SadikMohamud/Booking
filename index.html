<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Book Appointment - South Fade</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter,Arial,sans-serif;background:#000;color:#fff;padding:20px;min-height:100vh}
  .container{max-width:900px;margin:0 auto;background:#111;border:1px solid #333;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.6)}
  .header{background:#000;color:#ffd700;padding:28px;text-align:center;border-bottom:2px solid #ffd700}
  .header h1{margin-bottom:6px;font-size:1.8rem}
  .content{padding:28px}
  label{display:block;margin-bottom:6px;color:#ffd700;font-weight:600}
  input,select,textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #333;background:#1a1a1a;color:#fff;font-size:1rem;margin-bottom:14px}
  .flex{display:flex;gap:12px}
  .col{flex:1}
  .time-slots{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:8px}
  .slot{padding:10px;border-radius:8px;background:#222;border:1px solid #444;text-align:center;cursor:pointer;user-select:none}
  .slot:hover:not(.disabled){background:#2a2a2a;border-color:#ffd700;transform:translateY(-2px)}
  .slot.selected{background:#ffd700;color:#000;border-color:#ffd700;font-weight:700}
  .slot.disabled{background:#1a1a1a;color:#666;opacity:.6;cursor:not-allowed;text-decoration:line-through}
  .btn{width:100%;padding:14px;border-radius:8px;border:none;background:linear-gradient(135deg,#ffd700,#d4af37);color:#000;font-weight:800;cursor:pointer}
  .btn:disabled{background:#444;color:#777;cursor:not-allowed}
  .message{margin:16px 0;padding:12px;border-radius:8px;display:none}
  .message.active{display:block}
  .message.success{background:rgba(40,167,69,.08);color:#8fe08f;border:1px solid #2b7a44}
  .message.error{background:rgba(220,53,69,.06);color:#ff9aa8;border:1px solid #8a2a33}
  .loading{display:none;text-align:center;color:#ffd700;margin-top:10px}
  .loading.active{display:block}
  .muted{color:#999;font-size:.9rem}
  @media(max-width:640px){.flex{flex-direction:column}}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-cut"></i> South Fade Barbershop</h1>
      <div class="muted">Book your appointment — fast & simple</div>
    </div>

    <div class="content">
      <div id="msg" class="message"></div>

      <form id="bookingForm" autocomplete="off">
        <label for="name">Full name *</label>
        <input id="name" name="name" type="text" required placeholder="Alex Johnson">

        <div class="flex">
          <div class="col">
            <label for="email">Email *</label>
            <input id="email" name="email" type="email" required placeholder="you@example.com">
          </div>
          <div class="col">
            <label for="phone">Phone *</label>
            <input id="phone" name="phone" type="tel" required placeholder="+44 7...">
          </div>
        </div>

        <label for="service">Service *</label>
        <select id="service" required>
          <option value="">-- choose a service --</option>
        </select>

        <div class="flex">
          <div class="col">
            <label for="date">Preferred date *</label>
            <input id="date" type="date" required>
          </div>
          <div class="col">
            <label for="barber">Choose barber *</label>
            <select id="barber" required>
              <option value="">-- choose barber --</option>
              <option value="Moh">Moh</option>
              <option value="Alex">Alex</option>
              <option value="Yass">Yass</option>
              <option value="Ali">Ali</option>
            </select>
          </div>
        </div>

        <label>Available time slots *</label>
        <div id="slots" class="time-slots" aria-live="polite"></div>
        <input id="time" name="time" type="hidden" required>

        <label for="notes">Notes (optional)</label>
        <textarea id="notes" rows="3" placeholder="Anything we should know?"></textarea>

        <div style="margin-top:14px">
          <button id="submitBtn" class="btn" type="submit"><i class="fas fa-calendar-check"></i> Book appointment</button>
        </div>
        <div id="loading" class="loading"><div class="spinner"></div>Processing…</div>
      </form>

      <p class="muted" style="margin-top:18px">If you see a server error, open browser DevTools (Console) and paste the response shown there — I can help diagnose quickly.</p>
    </div>
  </div>

<script>
(() => {
  // ----- CONFIG (your Apps Script URL) -----
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhZNRIOPimun3NF-9ZTiSF7QHNISm1dczpIEHx6rg2eyElL7FKBLd1mxOHQ34exVM/exec";

  // Services list (same structure used in your apps script frontend)
  const services = [
    {cat:'Classic/Fade', items:[
      {name:'Buzz cut Fade', price:24, dur:40},
      {name:'Wash & cut', price:25, dur:40},
      {name:'Skin Fade', price:27, dur:40}
    ]},
    {cat:'Scissor Cut', items:[
      {name:'Scissor Cut', price:27, dur:40},
      {name:'Restyle Cut', price:30, dur:40}
    ]},
    {cat:'Beard Trim', items:[
      {name:'Beard Trim Clipper', price:17, dur:30},
      {name:'Beard Trim + Hot Towel', price:20, dur:30}
    ]},
    {cat:'Special Treatment', items:[
      {name:'Facial', price:20, dur:30},
      {name:'Face Mask', price:10, dur:30}
    ]}
  ];

  // Client-side barber schedule (0=Sun)
  const barberSchedule = {
    Moh: [1,2,3,4,5,6],
    Alex: [0,1,2,3,4,5,6], // Alex works every day
    Yass: [0,3,4,5,6],
    Ali: [1,2,3,4,5]
  };

  // DOM
  const form = document.getElementById('bookingForm');
  const serviceSel = document.getElementById('service');
  const dateInp = document.getElementById('date');
  const barberSel = document.getElementById('barber');
  const slotsDiv = document.getElementById('slots');
  const timeInp = document.getElementById('time');
  const notesInp = document.getElementById('notes');
  const msgDiv = document.getElementById('msg');
  const submitBtn = document.getElementById('submitBtn');
  const loadingEl = document.getElementById('loading');

  // helper show message
  function showMessage(text, type = 'error', duration = 5000) {
    msgDiv.textContent = text;
    msgDiv.className = `message ${type} active`;
    setTimeout(()=> msgDiv.classList.remove('active'), duration);
  }

  // populate services
  function populateServices(){
    services.forEach(group => {
      const og = document.createElement('optgroup');
      og.label = group.cat;
      group.items.forEach(item => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify(item);
        opt.textContent = `${item.name} — £${item.price}`;
        og.appendChild(opt);
      });
      serviceSel.appendChild(og);
    });
  }

  // update barber availability (grey out options)
  function updateBarbersForDate(dateStr){
    if(!dateStr) return;
    const day = new Date(dateStr).getDay();
    Array.from(barberSel.options).forEach(opt => {
      if(!opt.value) return; // skip placeholder
      const sched = barberSchedule[opt.value];
      if(Array.isArray(sched) && !sched.includes(day)){
        opt.disabled = true;
        opt.classList.add('disabled');
      } else {
        opt.disabled = false;
        opt.classList.remove('disabled');
      }
    });
  }

  // generate slots between open/close every dur minutes
  function genSlots(openHour, closeHour, durMin){
    const out = [];
    for(let h=openHour; h<closeHour; h++){
      for(let m=0; m<60; m+=durMin){
        out.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
      }
    }
    return out;
  }

  // fetch booked slots from Apps Script for date+barber
  async function getBookedSlots(date, barber){
    try{
      const resp = await fetch(`${SCRIPT_URL}?action=getBookings&date=${encodeURIComponent(date)}&barber=${encodeURIComponent(barber)}`);
      const json = await resp.json();
      // debug: log server body
      console.debug('getBookings response', json);
      return Array.isArray(json.bookedSlots) ? json.bookedSlots : [];
    }catch(err){
      console.error('getBookedSlots error', err);
      // show short message but keep console error for debug
      showMessage('Unable to load booked slots from server (see console).', 'error', 6000);
      return [];
    }
  }

  // render available slots (disabling booked ones)
  async function renderSlots(){
    // clear selection
    timeInp.value = '';
    slotsDiv.innerHTML = '';

    const svcVal = serviceSel.value;
    const dateVal = dateInp.value;
    const barberVal = barberSel.value;

    if(!svcVal || !dateVal || !barberVal){
      slotsDiv.innerHTML = `<div class="muted" style="color:#999">Select service, date and barber to see available times</div>`;
      return;
    }

    let svc;
    try { svc = JSON.parse(svcVal); } catch(e){ svc = null; }
    if(!svc || !svc.dur) {
      showMessage('Invalid service selected', 'error');
      return;
    }

    // business hours: Sun 9-17, Sat 9-19, Mon-Fri 9-20
    const day = new Date(dateVal).getDay();
    const [open, close] = (day === 0) ? [9,17] : (day === 6) ? [9,19] : [9,20];
    const allSlots = genSlots(open, close, svc.dur);

    // get booked
    const booked = await getBookedSlots(dateVal, barberVal);

    allSlots.forEach(t => {
      const d = document.createElement('div');
      d.className = 'slot';
      d.textContent = t;
      if(booked.includes(t)){
        d.classList.add('disabled');
      } else {
        d.addEventListener('click', ()=> {
          // unselect others
          document.querySelectorAll('.slot.selected').forEach(s => s.classList.remove('selected'));
          d.classList.add('selected');
          timeInp.value = t;
        });
      }
      slotsDiv.appendChild(d);
    });

    if(allSlots.length === 0){
      slotsDiv.innerHTML = `<div style="color:#999">No slots available</div>`;
    }
  }

  // POST createBooking to Apps Script
  async function createBooking(payload){
    try {
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      console.debug('createBooking response', json);
      return json;
    } catch(err) {
      console.error('createBooking fetch error', err);
      throw err;
    }
  }

  // attach events
  function attachEvents(){
    dateInp.addEventListener('change', () => {
      updateBarbersForDate(dateInp.value);
      renderSlots();
    });
    barberSel.addEventListener('change', renderSlots);
    serviceSel.addEventListener('change', renderSlots);

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      // client validation
      const name = form.name.value.trim();
      const email = form.email.value.trim();
      const phone = form.phone.value.trim();
      const svc = serviceSel.value ? JSON.parse(serviceSel.value) : null;
      const date = dateInp.value;
      const barber = barberSel.value;
      const time = timeInp.value;
      const notes = notesInp.value.trim();

      if(!name || !email || !phone || !svc || !date || !barber || !time){
        showMessage('Please fill all required fields and pick a time slot', 'error');
        return;
      }

      // Prepare payload
      const payload = {
        action: 'createBooking',
        name, email, phone,
        service: svc.name,
        price: svc.price,
        date, time,
        barber,
        notes
      };

      // UI: disable
      submitBtn.disabled = true;
      loadingEl.classList.add('active');
      msgDiv.className = 'message'; // hide

      try {
        const result = await createBooking(payload);
        if(result && result.success){
          showMessage('Booking confirmed! Check your email.', 'success', 7000);
          form.reset();
          slotsDiv.innerHTML = '';
        } else {
          // If server returned an error message, show it (useful for double-book prevention)
          const errText = (result && result.error) ? result.error : 'Booking failed. Server returned an error.';
          showMessage(errText, 'error', 8000);
        }
      } catch (err) {
        // network or other error
        showMessage('Server error. Please check the browser console and paste the error here for help.', 'error', 10000);
      } finally {
        submitBtn.disabled = false;
        loadingEl.classList.remove('active');
      }
    });
  }

  // init run
  function init(){
    populateServices();
    // set date min to today
    dateInp.min = new Date().toISOString().split('T')[0];
    attachEvents();
  }

  // start
  init();

  // expose small debug helper to console (optional)
  window._southFadeDebug = {
    SCRIPT_URL,
    renderSlots,
    getBookedSlots
  };

})();
</script>
</body>
</html>
