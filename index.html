<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>South Fade Booking</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Inter','Helvetica Neue',Arial,sans-serif;
      background:#000;
      color:#fff;
      min-height:100vh;
      padding:20px;
    }
    .container{
      max-width:900px;
      margin:0 auto;
      background:#111;
      border:1px solid #333;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
    }
    .header{
      background:#000;
      color:#FFD700;
      text-align:center;
      padding:30px 20px;
      border-bottom:2px solid #FFD700;
    }
    .header h1{font-size:2rem;margin-bottom:6px}
    .muted{color:#999;font-size:.9rem}
    .content{padding:28px}
    label{display:block;margin-bottom:6px;color:#FFD700;font-weight:600}
    input,select,textarea{
      width:100%;
      padding:12px;
      border-radius:8px;
      border:1px solid #333;
      background:#1a1a1a;
      color:#fff;
      font-size:1rem;
      margin-bottom:14px;
    }
    .flex{display:flex;gap:12px}
    .col{flex:1}
    .time-slots{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(90px,1fr));
      gap:10px;
      margin-top:8px;
      min-height:60px;
    }
    .slot{
      padding:10px;
      border-radius:8px;
      background:#222;
      border:1px solid #444;
      text-align:center;
      cursor:pointer;
      user-select:none;
      transition:all .15s;
    }
    .slot:hover:not(.disabled){
      background:#2a2a2a;
      border-color:#FFD700;
      transform:translateY(-2px);
    }
    .slot.selected{
      background:#FFD700;
      color:#000;
      border-color:#FFD700;
      font-weight:700;
    }
    .slot.disabled{
      background:#1a1a1a;
      color:#666;
      opacity:.6;
      cursor:not-allowed;
      text-decoration:line-through;
    }
    .btn{
      width:100%;
      padding:14px;
      border-radius:8px;
      border:none;
      background:linear-gradient(135deg,#FFD700,#d4af37);
      color:#000;
      font-weight:800;
      cursor:pointer;
      transition:all .2s;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,215,0,.3)}
    .btn:disabled{background:#444;color:#777;cursor:not-allowed;transform:none}
    .message{margin:16px 0;padding:12px;border-radius:8px;display:none}
    .message.active{display:block}
    .message.success{background:rgba(40,167,69,.08);color:#8fe08f;border:1px solid #2b7a44}
    .message.error{background:rgba(220,53,69,.06);color:#ff9aa8;border:1px solid #8a2a33}
    .message.info{background:rgba(255,215,0,.08);color:#FFD700;border:1px solid #aa9000}
    .gold-note{color:#FFD700;font-size:.9rem;margin-top:10px;text-align:center}
    .loading-slots{text-align:center;color:#999;padding:20px}
    @media(max-width:640px){.flex{flex-direction:column}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-cut"></i> South Fade Barbershop</h1>
      <div class="muted">Book your appointment ‚Äî fast & simple</div>
    </div>

    <div class="content">
      <div id="msg" class="message"></div>

      <form id="bookingForm" autocomplete="off">
        <label for="name">Full name *</label>
        <input id="name" name="name" required placeholder="Alex Johnson">

        <div class="flex">
          <div class="col">
            <label for="email">Email *</label>
            <input id="email" name="email" type="email" required placeholder="you@example.com">
          </div>
          <div class="col">
            <label for="phone">Phone *</label>
            <input id="phone" name="phone" required placeholder="+44 7‚Ä¶">
          </div>
        </div>

        <label for="service">Service *</label>
        <select id="service" required>
          <option value="">-- choose a service --</option>
          <optgroup label="Classic / Fade">
            <option value="Buzz cut Fade" data-price="24">Buzz cut Fade ‚Äî ¬£24</option>
            <option value="Wash & cut" data-price="25">Wash & cut ‚Äî ¬£25</option>
            <option value="Skin Fade" data-price="27">Skin Fade ‚Äî ¬£27</option>
          </optgroup>
          <optgroup label="Scissor Cut">
            <option value="Scissor Cut" data-price="27">Scissor Cut ‚Äî ¬£27</option>
            <option value="Restyle Cut" data-price="30">Restyle Cut ‚Äî ¬£30</option>
          </optgroup>
          <optgroup label="Beard Trim">
            <option value="Beard Trim Clipper" data-price="17">Beard Trim Clipper ‚Äî ¬£17</option>
            <option value="Beard Trim + Hot Towel" data-price="20">Beard Trim + Hot Towel ‚Äî ¬£20</option>
          </optgroup>
          <optgroup label="Special Treatment">
            <option value="Facial" data-price="20">Facial ‚Äî ¬£20</option>
            <option value="Face Mask" data-price="10">Face Mask ‚Äî ¬£10</option>
          </optgroup>
        </select>

        <div class="flex">
          <div class="col">
            <label for="date">Preferred date *</label>
            <input id="date" type="date" required>
          </div>
          <div class="col">
            <label for="barber">Choose Master Barber *</label>
            <select id="barber" required>
              <option value="">-- choose master barber --</option>
              <option value="Moh">Moh</option>
              <option value="Alex">Alex</option>
              <option value="Yass">Yass</option>
              <option value="Ali">Ali</option>
            </select>
          </div>
        </div>

        <label>Available time slots *</label>
        <div id="slots" class="time-slots">
          <div class="muted">Select date and barber first</div>
        </div>
        <input id="time" name="time" type="hidden" required>

        <label for="notes">Notes (optional)</label>
        <textarea id="notes" rows="3" placeholder="Anything we should know?"></textarea>

        <p class="gold-note">At South Fade we kindly ask you to cancel your booking before rescheduling.</p>

        <button class="btn" type="submit" id="submitBtn"><i class="fas fa-calendar-check"></i> Book Appointment</button>
      </form>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ========== REPLACE WITH YOUR SUPABASE CREDENTIALS ==========
    const SUPABASE_URL = 'https://ufcfbggsjemgzcmdhpts.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmY2ZiZ2dzamVtZ3pjbWRocHRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNjMzNjYsImV4cCI6MjA3NTkzOTM2Nn0.IWB96tPDcVcCp36azPNLewik41xL3FrDjLLtIMqwT-4';
    // ============================================================

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Barber schedules
    const BARBER_SCHEDULE = {
      'Yass': [3,4,5,6], // Wed-Sat
      'Alex': [0,1,2,3,4,5,6], // Every day
      'Moh': [1,2], // Mon-Tue
      'Ali': [5,6,0] // Fri-Sun
    };

    const SHOP_HOURS = {
      0: {open:9, close:18}, // Sunday
      1: {open:9, close:20}, // Monday
      2: {open:9, close:20}, // Tuesday
      3: {open:9, close:20}, // Wednesday
      4: {open:9, close:20}, // Thursday
      5: {open:9, close:20}, // Friday
      6: {open:9, close:19}  // Saturday
    };

    const form = document.getElementById('bookingForm');
    const msg = document.getElementById('msg');
    const slotsDiv = document.getElementById('slots');
    const dateInp = document.getElementById('date');
    const barberSel = document.getElementById('barber');
    const timeInp = document.getElementById('time');
    const submitBtn = document.getElementById('submitBtn');

    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    dateInp.setAttribute('min', today);

    function showMessage(text, type='error', ms=5000) {
      msg.textContent = text;
      msg.className = 'message ' + type + ' active';
      setTimeout(() => msg.classList.remove('active'), ms);
    }

    // Generate 40-minute time slots
    function genSlots(dateStr) {
      const d = new Date(dateStr + 'T12:00:00');
      const dayOfWeek = d.getDay();
      const hours = SHOP_HOURS[dayOfWeek];
      
      const slots = [];
      let minutes = hours.open * 60;
      const closeMinutes = hours.close * 60;
      
      while (minutes + 40 <= closeMinutes) {
        const h = Math.floor(minutes / 60);
        const m = minutes % 60;
        slots.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
        minutes += 40;
      }
      return slots;
    }

    // Check if barber works on this day
    function isBarberWorking(barber, dateStr) {
      const d = new Date(dateStr + 'T12:00:00');
      const dayOfWeek = d.getDay();
      return BARBER_SCHEDULE[barber]?.includes(dayOfWeek) || false;
    }

    // Get booked slots from Supabase
    async function getBookedSlots(barber, date) {
      const { data, error } = await supabase
        .from('bookings')
        .select('booking_time')
        .eq('barber', barber)
        .eq('booking_date', date)
        .neq('status', 'cancelled');
      
      if (error) {
        console.error('Error fetching bookings:', error);
        return [];
      }
      
      return data.map(b => b.booking_time);
    }

    // Render time slots
    async function renderSlots() {
      const date = dateInp.value;
      const barber = barberSel.value;
      
      slotsDiv.innerHTML = '';
      timeInp.value = '';
      
      if (!date || !barber) {
        slotsDiv.innerHTML = '<div class="muted">Select date and barber first</div>';
        return;
      }

      // Check if barber works on this day
      if (!isBarberWorking(barber, date)) {
        slotsDiv.innerHTML = '<div class="muted" style="color:#ff9aa8">‚ö†Ô∏è ' + barber + ' is not available on this day</div>';
        showMessage(barber + ' doesn\'t work on this day. Please choose another date.', 'info');
        return;
      }

      slotsDiv.innerHTML = '<div class="loading-slots"><i class="fas fa-spinner fa-spin"></i> Loading available slots...</div>';

      const bookedSlots = await getBookedSlots(barber, date);
      const allSlots = genSlots(date);

      slotsDiv.innerHTML = '';

      if (allSlots.length === 0) {
        slotsDiv.innerHTML = '<div class="muted">No slots available for this day</div>';
        return;
      }

      allSlots.forEach(time => {
        const el = document.createElement('div');
        el.textContent = time;
        el.className = 'slot';
        
        if (bookedSlots.includes(time)) {
          el.classList.add('disabled');
          el.title = 'Already booked';
        } else {
          el.onclick = () => {
            document.querySelectorAll('.slot.selected').forEach(s => s.classList.remove('selected'));
            el.classList.add('selected');
            timeInp.value = time;
          };
        }
        
        slotsDiv.appendChild(el);
      });
    }

    dateInp.addEventListener('change', renderSlots);
    barberSel.addEventListener('change', renderSlots);

    // Handle form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const data = {
        customer_name: formData.get('name'),
        customer_email: formData.get('email'),
        customer_phone: formData.get('phone'),
        service: formData.get('service'),
        barber: barberSel.value,
        booking_date: dateInp.value,
        booking_time: timeInp.value,
        notes: formData.get('notes') || '',
        status: 'Confirmed'
      };

      // Get price from selected service
      const serviceOption = document.querySelector('#service option:checked');
      data.price = parseFloat(serviceOption?.dataset?.price || 0);

      // Validate
      if (!data.booking_time) {
        showMessage('Please select a time slot', 'error');
        return;
      }

      if (!isBarberWorking(data.barber, data.booking_date)) {
        showMessage(data.barber + ' is not available on this date', 'error');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Booking...';

      // Double-check availability
      const bookedSlots = await getBookedSlots(data.barber, data.booking_date);
      if (bookedSlots.includes(data.booking_time)) {
        showMessage('This time slot was just booked. Please choose another.', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-calendar-check"></i> Book Appointment';
        await renderSlots();
        return;
      }

      // Create booking
      const { error } = await supabase
        .from('bookings')
        .insert([data]);

      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-calendar-check"></i> Book Appointment';

      if (error) {
        console.error('Booking error:', error);
        showMessage('Failed to create booking. Please try again.', 'error');
        return;
      }

      showMessage('üéâ Booking confirmed! See you at South Fade.', 'success', 6000);
      form.reset();
      slotsDiv.innerHTML = '<div class="muted">Select date and barber first</div>';
      timeInp.value = '';
    });
  </script>
</body>
</html>